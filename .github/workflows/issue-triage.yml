name: Issue Triage

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  contents: read
  issues: write
  repository-projects: write

jobs:
  triage:
    runs-on: ubuntu-latest
    env:
      PROJECT_TOKEN: ${{ secrets.PROJECT_TOKEN }}

    steps:
      - name: Ensure triage labels exist
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const labels = [
              { name: "needs-triage", color: "C5DEF5", description: "Needs initial triage" },
              { name: "status: backlog", color: "EDEDED", description: "Backlog item" },
              { name: "status: review", color: "FBCA04", description: "In review / PR open" },
              { name: "status: done", color: "0E8A16", description: "Completed and merged" },
              { name: "status: ready", color: "BFDADC", description: "Ready for implementation" },
              { name: "type: bug", color: "D73A4A", description: "Bug or regression" },
              { name: "type: security", color: "B60205", description: "Security issue" },
              { name: "type: refactor", color: "5319E7", description: "Refactoring or technical debt" },
              { name: "type: chore", color: "0E8A16", description: "Tooling/maintenance work" },
              { name: "type: feature", color: "1D76DB", description: "New feature or enhancement" },
              { name: "priority: p0", color: "B60205", description: "Critical priority" },
              { name: "priority: p1", color: "D93F0B", description: "High priority" },
              { name: "priority: p2", color: "FBCA04", description: "Medium priority" },
              { name: "priority: p3", color: "0E8A16", description: "Low priority" },
              { name: "area: auth", color: "0052CC", description: "Authentication and signup/login" },
              { name: "area: board", color: "006B75", description: "Board and task flow" },
              { name: "area: contacts", color: "1D76DB", description: "Contacts management" },
              { name: "area: summary", color: "5319E7", description: "Summary/dashboard" },
              { name: "area: storage", color: "BFD4F2", description: "Storage, API, Firebase" },
              { name: "area: ui", color: "F9D0C4", description: "UI and styling" },
              { name: "area: tooling", color: "C2E0C6", description: "CI/CD and tooling" }
            ];

            for (const label of labels) {
              try {
                await github.rest.issues.updateLabel({
                  ...context.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    ...context.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                } else {
                  throw error;
                }
              }
            }

      - name: Checkout repository for triage classifier
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Apply labels from issue content
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { classifyIssue } = require("./scripts/issue_triage_classifier.cjs");
            const issue = context.payload.issue;
            const issueNumber = issue.number;

            const existing = new Set(issue.labels.map((l) => l.name));
            const toAdd = classifyIssue({
              title: issue.title || "",
              body: issue.body || "",
              existingLabels: [...existing],
            });
            if (toAdd.length > 0) {
              await github.rest.issues.addLabels({
                ...context.repo,
                issue_number: issueNumber,
                labels: toAdd
              });
            }

      - name: Add issue to GitHub project (optional)
        if: ${{ vars.GH_PROJECT_URL != '' && env.PROJECT_TOKEN != '' }}
        uses: actions/add-to-project@244f685bbc3b7adfa8466e08b698b5577571133e # v1.0.2
        with:
          project-url: ${{ vars.GH_PROJECT_URL }}
          github-token: ${{ env.PROJECT_TOKEN }}
        continue-on-error: true
